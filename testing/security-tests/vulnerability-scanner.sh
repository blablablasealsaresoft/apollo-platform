#!/bin/bash

# Apollo Platform Comprehensive Security Testing Script

set -e

echo "========================================="
echo "Apollo Platform Security Testing Suite"
echo "========================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Directories
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
REPORT_DIR="${SCRIPT_DIR}/reports"
mkdir -p "${REPORT_DIR}"

# Create timestamped report directory
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_SUBDIR="${REPORT_DIR}/${TIMESTAMP}"
mkdir -p "${REPORT_SUBDIR}"

echo "Reports will be saved to: ${REPORT_SUBDIR}"
echo ""

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to print section header
print_section() {
    echo ""
    echo "========================================="
    echo "$1"
    echo "========================================="
    echo ""
}

# 1. Dependency Vulnerability Scanning
print_section "1. Scanning Dependencies for Known Vulnerabilities"

if command_exists npm; then
    echo "Running npm audit..."
    npm audit --json > "${REPORT_SUBDIR}/npm-audit.json" || true
    npm audit --audit-level=moderate || true
    echo -e "${GREEN}✓ npm audit completed${NC}"
else
    echo -e "${YELLOW}⚠ npm not found, skipping npm audit${NC}"
fi

# Snyk scanning
if command_exists snyk; then
    echo "Running Snyk security scan..."
    snyk test --json > "${REPORT_SUBDIR}/snyk-report.json" || true
    snyk test --severity-threshold=high || true
    echo -e "${GREEN}✓ Snyk scan completed${NC}"
else
    echo -e "${YELLOW}⚠ Snyk not found, skipping Snyk scan${NC}"
    echo "Install with: npm install -g snyk"
fi

# 2. Secret Scanning
print_section "2. Scanning for Exposed Secrets"

if command_exists trufflehog; then
    echo "Running TruffleHog secret scan..."
    trufflehog filesystem . --json > "${REPORT_SUBDIR}/trufflehog-report.json" || true
    echo -e "${GREEN}✓ TruffleHog scan completed${NC}"
else
    echo -e "${YELLOW}⚠ TruffleHog not found, skipping secret scan${NC}"
    echo "Install with: pip install trufflehog"
fi

# Git-secrets
if command_exists git-secrets; then
    echo "Running git-secrets scan..."
    git secrets --scan > "${REPORT_SUBDIR}/git-secrets-report.txt" || true
    echo -e "${GREEN}✓ git-secrets scan completed${NC}"
else
    echo -e "${YELLOW}⚠ git-secrets not found, skipping${NC}"
fi

# 3. Static Application Security Testing (SAST)
print_section "3. Static Application Security Testing"

if command_exists semgrep; then
    echo "Running Semgrep SAST..."
    semgrep --config=auto --json --output="${REPORT_SUBDIR}/semgrep-report.json" . || true
    semgrep --config=auto . || true
    echo -e "${GREEN}✓ Semgrep scan completed${NC}"
else
    echo -e "${YELLOW}⚠ Semgrep not found, skipping SAST${NC}"
    echo "Install with: pip install semgrep"
fi

# Bandit for Python code
if command_exists bandit; then
    echo "Running Bandit Python security scan..."
    bandit -r . -f json -o "${REPORT_SUBDIR}/bandit-report.json" || true
    echo -e "${GREEN}✓ Bandit scan completed${NC}"
else
    echo -e "${YELLOW}⚠ Bandit not found, skipping Python scan${NC}"
fi

# 4. Docker Image Scanning
print_section "4. Docker Image Security Scanning"

if command_exists trivy; then
    echo "Running Trivy container scan..."
    docker images --format "{{.Repository}}:{{.Tag}}" | grep apollo | while read image; do
        echo "Scanning image: $image"
        trivy image --format json --output "${REPORT_SUBDIR}/trivy-${image//\//-}.json" "$image" || true
    done
    echo -e "${GREEN}✓ Trivy scan completed${NC}"
else
    echo -e "${YELLOW}⚠ Trivy not found, skipping container scan${NC}"
    echo "Install with: brew install aquasecurity/trivy/trivy"
fi

# 5. OWASP ZAP Dynamic Scan
print_section "5. OWASP ZAP Dynamic Application Security Testing"

if command_exists zap-cli; then
    echo "Starting OWASP ZAP scan..."
    echo "Note: Ensure Apollo platform is running on http://localhost:3000"

    # Start ZAP daemon
    zap-cli start --start-options '-config api.disablekey=true' &
    ZAP_PID=$!

    sleep 10  # Wait for ZAP to start

    # Open URL
    zap-cli open-url http://localhost:3000

    # Spider
    echo "Running spider..."
    zap-cli spider http://localhost:3000

    # Active scan
    echo "Running active scan..."
    zap-cli active-scan http://localhost:3000

    # Wait for scan to complete
    zap-cli status --timeout 300

    # Generate reports
    zap-cli report -o "${REPORT_SUBDIR}/zap-report.html" -f html
    zap-cli report -o "${REPORT_SUBDIR}/zap-report.json" -f json

    # Shutdown ZAP
    zap-cli shutdown

    echo -e "${GREEN}✓ OWASP ZAP scan completed${NC}"
else
    echo -e "${YELLOW}⚠ ZAP CLI not found, skipping dynamic scan${NC}"
    echo "Install with: pip install zaproxy"
fi

# 6. SSL/TLS Testing
print_section "6. SSL/TLS Configuration Testing"

if command_exists testssl; then
    echo "Running testssl.sh..."
    testssl --jsonfile "${REPORT_SUBDIR}/testssl-report.json" https://localhost:443 || true
    echo -e "${GREEN}✓ SSL/TLS scan completed${NC}"
else
    echo -e "${YELLOW}⚠ testssl not found, skipping SSL/TLS scan${NC}"
fi

# 7. API Security Testing
print_section "7. API Security Testing"

echo "Running custom API security tests..."
node "${SCRIPT_DIR}/api-security-tests.js" > "${REPORT_SUBDIR}/api-security-report.txt" || true
echo -e "${GREEN}✓ API security tests completed${NC}"

# 8. Authentication & Authorization Tests
print_section "8. Authentication & Authorization Security Tests"

echo "Running authentication security tests..."
npm run test:security:auth > "${REPORT_SUBDIR}/auth-security-tests.txt" || true
echo -e "${GREEN}✓ Auth security tests completed${NC}"

# 9. Generate Summary Report
print_section "9. Generating Summary Report"

cat > "${REPORT_SUBDIR}/SUMMARY.md" << EOF
# Apollo Platform Security Test Report
**Generated:** $(date)
**Report Directory:** ${REPORT_SUBDIR}

## Executive Summary

This report contains the results of comprehensive security testing performed on the Apollo Platform.

## Tests Performed

1. **Dependency Vulnerability Scanning**
   - npm audit
   - Snyk analysis

2. **Secret Scanning**
   - TruffleHog
   - git-secrets

3. **Static Application Security Testing (SAST)**
   - Semgrep
   - Bandit (Python)

4. **Container Security Scanning**
   - Trivy

5. **Dynamic Application Security Testing (DAST)**
   - OWASP ZAP

6. **SSL/TLS Configuration Testing**
   - testssl.sh

7. **API Security Testing**
   - Custom API vulnerability tests

8. **Authentication & Authorization Testing**
   - RBAC validation
   - Session management tests
   - JWT security tests

## Report Files

- \`npm-audit.json\`: npm dependency vulnerabilities
- \`snyk-report.json\`: Snyk vulnerability analysis
- \`trufflehog-report.json\`: Secret detection results
- \`semgrep-report.json\`: SAST findings
- \`trivy-*.json\`: Container vulnerability scans
- \`zap-report.html\`: OWASP ZAP detailed report
- \`zap-report.json\`: OWASP ZAP JSON results
- \`api-security-report.txt\`: API security test results
- \`auth-security-tests.txt\`: Authentication test results

## Recommendations

Review all HIGH and CRITICAL severity findings immediately.
Address MEDIUM severity findings in the next sprint.
Monitor LOW severity findings for future remediation.

## Next Steps

1. Review all reports in this directory
2. Create tickets for identified vulnerabilities
3. Implement fixes and re-test
4. Update security documentation

EOF

echo -e "${GREEN}✓ Summary report generated${NC}"

# Print final summary
print_section "Security Testing Complete"

echo "All security tests completed!"
echo "Reports saved to: ${REPORT_SUBDIR}"
echo ""
echo "View summary: cat ${REPORT_SUBDIR}/SUMMARY.md"
echo ""
echo -e "${GREEN}Security scan completed successfully!${NC}"

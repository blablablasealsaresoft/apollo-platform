# Prometheus Recording Rules for Apollo Platform
# Pre-computed aggregations for dashboard performance

groups:
  # API Request Metrics Aggregations
  - name: apollo_api_recording_rules
    interval: 30s
    rules:
      # Request rate by service (5m window)
      - record: apollo:api_request_rate:5m
        expr: sum(rate(http_requests_total[5m])) by (service, method, status)

      # Total request rate per service
      - record: apollo:api_request_rate_total:5m
        expr: sum(rate(http_requests_total[5m])) by (service)

      # Error rate by service
      - record: apollo:api_error_rate:5m
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
          /
          sum(rate(http_requests_total[5m])) by (service)

      # P50 latency
      - record: apollo:api_request_latency:p50
        expr: |
          histogram_quantile(0.50,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          )

      # P95 latency
      - record: apollo:api_request_latency:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          )

      # P99 latency
      - record: apollo:api_request_latency:p99
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          )

      # Average latency
      - record: apollo:api_request_latency:avg
        expr: |
          sum(rate(http_request_duration_seconds_sum[5m])) by (service)
          /
          sum(rate(http_request_duration_seconds_count[5m])) by (service)

      # Requests per second
      - record: apollo:api_requests_per_second
        expr: sum(rate(http_requests_total[1m])) by (service)

  # Resource Usage Aggregations
  - name: apollo_resource_recording_rules
    interval: 30s
    rules:
      # CPU usage per pod
      - record: apollo:pod_cpu_usage:rate5m
        expr: |
          sum(rate(container_cpu_usage_seconds_total{namespace="apollo-production"}[5m])) by (pod)

      # CPU usage percentage per pod
      - record: apollo:pod_cpu_usage_percent
        expr: |
          100 * sum(rate(container_cpu_usage_seconds_total{namespace="apollo-production"}[5m])) by (pod)
          /
          sum(container_spec_cpu_quota{namespace="apollo-production"} / container_spec_cpu_period{namespace="apollo-production"}) by (pod)

      # Memory usage per pod
      - record: apollo:pod_memory_usage_bytes
        expr: sum(container_memory_working_set_bytes{namespace="apollo-production"}) by (pod)

      # Memory usage percentage per pod
      - record: apollo:pod_memory_usage_percent
        expr: |
          100 * container_memory_working_set_bytes{namespace="apollo-production"}
          /
          container_spec_memory_limit_bytes{namespace="apollo-production"}

      # Network receive rate per pod
      - record: apollo:pod_network_receive_rate:5m
        expr: sum(rate(container_network_receive_bytes_total{namespace="apollo-production"}[5m])) by (pod)

      # Network transmit rate per pod
      - record: apollo:pod_network_transmit_rate:5m
        expr: sum(rate(container_network_transmit_bytes_total{namespace="apollo-production"}[5m])) by (pod)

      # Disk usage per node
      - record: apollo:node_disk_usage_percent
        expr: |
          100 * (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}))

      # Total cluster CPU usage
      - record: apollo:cluster_cpu_usage_percent
        expr: |
          100 * sum(rate(container_cpu_usage_seconds_total{namespace="apollo-production"}[5m]))
          /
          sum(machine_cpu_cores)

      # Total cluster memory usage
      - record: apollo:cluster_memory_usage_percent
        expr: |
          100 * sum(container_memory_working_set_bytes{namespace="apollo-production"})
          /
          sum(machine_memory_bytes)

  # Database Metrics Aggregations
  - name: apollo_database_recording_rules
    interval: 30s
    rules:
      # PostgreSQL connections usage ratio
      - record: apollo:postgres_connections_ratio
        expr: |
          pg_stat_database_numbackends
          /
          pg_settings_max_connections

      # PostgreSQL transaction rate
      - record: apollo:postgres_transaction_rate:5m
        expr: sum(rate(pg_stat_database_xact_commit[5m])) + sum(rate(pg_stat_database_xact_rollback[5m]))

      # PostgreSQL commit rate
      - record: apollo:postgres_commit_rate:5m
        expr: sum(rate(pg_stat_database_xact_commit[5m]))

      # PostgreSQL rollback rate
      - record: apollo:postgres_rollback_rate:5m
        expr: sum(rate(pg_stat_database_xact_rollback[5m]))

      # PostgreSQL cache hit ratio
      - record: apollo:postgres_cache_hit_ratio
        expr: |
          sum(pg_stat_database_blks_hit)
          /
          (sum(pg_stat_database_blks_hit) + sum(pg_stat_database_blks_read))

      # Redis memory usage ratio
      - record: apollo:redis_memory_usage_ratio
        expr: redis_memory_used_bytes / redis_memory_max_bytes

      # Redis connections
      - record: apollo:redis_connections
        expr: redis_connected_clients

      # Redis keyspace hit ratio
      - record: apollo:redis_keyspace_hit_ratio
        expr: |
          redis_keyspace_hits_total
          /
          (redis_keyspace_hits_total + redis_keyspace_misses_total)

      # Elasticsearch cluster health
      - record: apollo:elasticsearch_cluster_health
        expr: elasticsearch_cluster_health_status

      # Elasticsearch document count
      - record: apollo:elasticsearch_docs_total
        expr: sum(elasticsearch_indices_docs)

      # Elasticsearch indexing rate
      - record: apollo:elasticsearch_indexing_rate:5m
        expr: sum(rate(elasticsearch_indices_indexing_index_total[5m]))

  # Authentication Metrics Aggregations
  - name: apollo_auth_recording_rules
    interval: 30s
    rules:
      # Authentication success rate
      - record: apollo:auth_success_rate:5m
        expr: |
          sum(rate(authentication_attempts_total{result="success"}[5m]))
          /
          sum(rate(authentication_attempts_total[5m]))

      # Authentication failure rate
      - record: apollo:auth_failure_rate:5m
        expr: |
          sum(rate(authentication_attempts_total{result="failure"}[5m]))
          /
          sum(rate(authentication_attempts_total[5m]))

      # Authentication attempts per minute
      - record: apollo:auth_attempts_per_minute
        expr: sum(rate(authentication_attempts_total[1m])) * 60

      # Failed auth attempts by IP
      - record: apollo:auth_failures_by_ip:5m
        expr: sum(rate(authentication_attempts_total{result="failure"}[5m])) by (source_ip)

      # Active sessions
      - record: apollo:active_sessions
        expr: sum(active_user_sessions)

      # Session creation rate
      - record: apollo:session_creation_rate:5m
        expr: sum(rate(session_created_total[5m]))

  # Business Metrics Aggregations
  - name: apollo_business_recording_rules
    interval: 60s
    rules:
      # Active investigations
      - record: apollo:active_investigations
        expr: sum(apollo_active_investigations)

      # Total targets monitored
      - record: apollo:targets_monitored
        expr: sum(apollo_targets_monitored)

      # Surveillance match rate
      - record: apollo:surveillance_match_rate:1h
        expr: sum(rate(apollo_surveillance_matches[1h]))

      # OSINT collection rate
      - record: apollo:osint_collection_rate:5m
        expr: sum(rate(osint_records_collected_total[5m]))

      # Blockchain transactions traced
      - record: apollo:blockchain_traces_rate:5m
        expr: sum(rate(blockchain_transactions_traced_total[5m]))

      # Facial recognition scans per minute
      - record: apollo:facial_recognition_scans_per_minute
        expr: sum(rate(facial_recognition_scans_total[1m])) * 60

      # Investigation processing time
      - record: apollo:investigation_processing_time:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(investigation_processing_duration_seconds_bucket[5m])) by (le)
          )

      # Alert response time
      - record: apollo:alert_response_time:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(alert_response_duration_seconds_bucket[5m])) by (le)
          )

  # Service Health Aggregations
  - name: apollo_health_recording_rules
    interval: 30s
    rules:
      # Service availability
      - record: apollo:service_availability
        expr: avg(up{job=~"apollo-.*"}) by (job)

      # Service uptime (30-day rolling)
      - record: apollo:service_uptime:30d
        expr: |
          avg_over_time(up{job=~"apollo-.*"}[30d])

      # Service restart count (24h)
      - record: apollo:service_restarts:24h
        expr: |
          increase(kube_pod_container_status_restarts_total{namespace="apollo-production"}[24h])

      # Pod ready status
      - record: apollo:pods_ready
        expr: |
          sum(kube_pod_status_ready{namespace="apollo-production", condition="true"}) by (pod)

      # Deployment replica status
      - record: apollo:deployment_replicas_available
        expr: |
          kube_deployment_status_replicas_available{namespace="apollo-production"}
          /
          kube_deployment_spec_replicas{namespace="apollo-production"}

  # Queue and Processing Aggregations
  - name: apollo_queue_recording_rules
    interval: 30s
    rules:
      # Message queue depth
      - record: apollo:queue_depth
        expr: sum(rabbitmq_queue_messages) by (queue)

      # Message processing rate
      - record: apollo:queue_processing_rate:5m
        expr: sum(rate(rabbitmq_queue_messages_delivered_total[5m])) by (queue)

      # Message publish rate
      - record: apollo:queue_publish_rate:5m
        expr: sum(rate(rabbitmq_queue_messages_published_total[5m])) by (queue)

      # Consumer count
      - record: apollo:queue_consumers
        expr: sum(rabbitmq_queue_consumers) by (queue)

      # Celery task queue length
      - record: apollo:celery_queue_length
        expr: sum(celery_queue_length) by (queue_name)

      # Celery task success rate
      - record: apollo:celery_task_success_rate:5m
        expr: |
          sum(rate(celery_task_succeeded_total[5m])) by (task)
          /
          sum(rate(celery_task_received_total[5m])) by (task)

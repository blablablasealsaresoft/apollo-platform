version: '3.8'

# Apollo Platform - Database Infrastructure
# High-performance, production-ready database stack for criminal investigations
# Optimized for: Ignatova hunt, blockchain forensics, facial recognition, OSINT

services:
  # PostgreSQL - Primary relational database
  postgresql:
    image: postgres:15-alpine
    container_name: apollo-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_DB: apollo
      POSTGRES_USER: apollo_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_in_production}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgresql_data:/var/lib/postgresql/data
      - ./postgresql/schemas:/docker-entrypoint-initdb.d
      - ./postgresql/postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apollo_admin -d apollo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # TimescaleDB - Time-series extension for PostgreSQL (blockchain transactions, surveillance)
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: apollo-timescaledb
    restart: unless-stopped
    environment:
      POSTGRES_DB: apollo_timeseries
      POSTGRES_USER: apollo_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_in_production}
    ports:
      - "5433:5432"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./timescaledb/schemas:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apollo_admin -d apollo_timeseries"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Neo4j - Graph database for criminal networks
  neo4j:
    image: neo4j:5.14-community
    container_name: apollo-neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-apollo_neo4j_2026}
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_memory_pagecache_size: 2G
      NEO4J_dbms_memory_heap_initial__size: 2G
      NEO4J_dbms_memory_heap_max__size: 4G
      NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*
      NEO4J_dbms_security_procedures_allowlist: apoc.*,gds.*
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
      - ./neo4j/schemas:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${NEO4J_PASSWORD:-apollo_neo4j_2026} 'RETURN 1'"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 6G
        reservations:
          cpus: '2.0'
          memory: 4G

  # Redis - Cache, sessions, pub/sub for real-time alerts
  redis:
    image: redis:7-alpine
    container_name: apollo-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-apollo_redis_secure}
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  # Elasticsearch - Full-text search and intelligence indexing
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: apollo-elasticsearch
    restart: unless-stopped
    environment:
      - node.name=apollo-es-node
      - cluster.name=apollo-cluster
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-apollo_elastic_2026}
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
      - ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
      - ./elasticsearch/mappings:/usr/share/elasticsearch/mappings
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTIC_PASSWORD:-apollo_elastic_2026} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\\|yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Kibana - Elasticsearch visualization (optional, for development)
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    container_name: apollo-kibana
    restart: unless-stopped
    environment:
      ELASTICSEARCH_HOSTS: '["http://elasticsearch:9200"]'
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: ${ELASTIC_PASSWORD:-apollo_elastic_2026}
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:5601/api/status | grep -q '\"state\":\"green\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  # RabbitMQ - Message queue for async processing
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: apollo-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: apollo
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-apollo_rabbitmq_2026}
      RABBITMQ_DEFAULT_VHOST: apollo
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # MongoDB - Document store for unstructured intelligence data
  mongodb:
    image: mongo:7-jammy
    container_name: apollo-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: apollo_admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-apollo_mongo_2026}
      MONGO_INITDB_DATABASE: apollo
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - apollo-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

networks:
  apollo-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  postgresql_data:
    driver: local
  timescaledb_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local
  redis_data:
    driver: local
  elasticsearch_data:
    driver: local
  rabbitmq_data:
    driver: local
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

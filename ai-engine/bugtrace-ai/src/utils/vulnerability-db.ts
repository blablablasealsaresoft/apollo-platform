/**
 * BugTrace-AI Vulnerability Database
 * Knowledge base of vulnerability patterns and remediation
 * @module utils/vulnerability-db
 */

export interface VulnerabilityInfo {
  id: string;
  name: string;
  cwe: string;
  owasp: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  description: string;
  impact: string;
  remediation: string;
  references: string[];
}

export const VULNERABILITY_DB: Record<string, VulnerabilityInfo> = {
  'sql-injection': {
    id: 'sql-injection',
    name: 'SQL Injection',
    cwe: 'CWE-89',
    owasp: 'A03:2021 - Injection',
    severity: 'critical',
    description: 'SQL injection allows attackers to interfere with database queries',
    impact: 'Database compromise, data theft, authentication bypass',
    remediation: 'Use parameterized queries, input validation, ORM',
    references: [
      'https://owasp.org/www-community/attacks/SQL_Injection',
      'https://cwe.mitre.org/data/definitions/89.html'
    ]
  },
  'xss': {
    id: 'xss',
    name: 'Cross-Site Scripting',
    cwe: 'CWE-79',
    owasp: 'A03:2021 - Injection',
    severity: 'high',
    description: 'XSS allows injection of malicious scripts into web pages',
    impact: 'Session hijacking, credential theft, malware delivery',
    remediation: 'Output encoding, Content Security Policy, input validation',
    references: [
      'https://owasp.org/www-community/attacks/xss/',
      'https://cwe.mitre.org/data/definitions/79.html'
    ]
  },
  'rce': {
    id: 'rce',
    name: 'Remote Code Execution',
    cwe: 'CWE-78',
    owasp: 'A03:2021 - Injection',
    severity: 'critical',
    description: 'RCE allows execution of arbitrary code on the server',
    impact: 'Complete system compromise',
    remediation: 'Avoid dangerous functions, input validation, sandboxing',
    references: [
      'https://cwe.mitre.org/data/definitions/78.html'
    ]
  },
  'xxe': {
    id: 'xxe',
    name: 'XML External Entity',
    cwe: 'CWE-611',
    owasp: 'A05:2021 - Security Misconfiguration',
    severity: 'high',
    description: 'XXE allows processing of external entities in XML',
    impact: 'File disclosure, SSRF, denial of service',
    remediation: 'Disable external entity processing, use secure XML parsers',
    references: [
      'https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing'
    ]
  },
  'ssti': {
    id: 'ssti',
    name: 'Server-Side Template Injection',
    cwe: 'CWE-94',
    owasp: 'A03:2021 - Injection',
    severity: 'critical',
    description: 'SSTI allows injection into template engines',
    impact: 'Remote code execution, server compromise',
    remediation: 'Use safe template configurations, input sanitization',
    references: [
      'https://portswigger.net/research/server-side-template-injection'
    ]
  }
};

export class VulnerabilityDatabase {
  getInfo(vulnId: string): VulnerabilityInfo | undefined {
    return VULNERABILITY_DB[vulnId];
  }

  search(query: string): VulnerabilityInfo[] {
    return Object.values(VULNERABILITY_DB).filter(vuln =>
      vuln.name.toLowerCase().includes(query.toLowerCase()) ||
      vuln.description.toLowerCase().includes(query.toLowerCase())
    );
  }

  getByCWE(cwe: string): VulnerabilityInfo[] {
    return Object.values(VULNERABILITY_DB).filter(vuln => vuln.cwe === cwe);
  }

  getByOWASP(owasp: string): VulnerabilityInfo[] {
    return Object.values(VULNERABILITY_DB).filter(vuln => vuln.owasp.includes(owasp));
  }

  getBySeverity(severity: VulnerabilityInfo['severity']): VulnerabilityInfo[] {
    return Object.values(VULNERABILITY_DB).filter(vuln => vuln.severity === severity);
  }
}

export default new VulnerabilityDatabase();

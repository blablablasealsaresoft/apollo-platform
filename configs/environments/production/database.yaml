# Apollo Platform - Production Database Configuration
# ===========================================================

environment: production

databases:
  # PostgreSQL - Primary relational database
  postgresql:
    host: prod-db.internal
    port: 5432
    database: apollo
    user: apollo_admin
    password: ${POSTGRES_PASSWORD}  # From Kubernetes secret or env
    pool_size: 50
    max_connections: 100
    min_connections: 10
    idle_timeout: 30000
    connection_timeout: 10000

    # SSL/TLS Configuration
    ssl: true
    ssl_mode: require
    ssl_ca: /etc/ssl/certs/ca.crt
    ssl_cert: /etc/ssl/certs/client.crt
    ssl_key: /etc/ssl/private/client.key

    # Connection options
    application_name: apollo_production
    statement_timeout: 30000
    idle_in_transaction_session_timeout: 60000
    lock_timeout: 10000

    # High Availability
    replication:
      enabled: true
      mode: synchronous
      standby_servers:
        - host: prod-db-standby1.internal
          port: 5432
        - host: prod-db-standby2.internal
          port: 5432
      failover_timeout: 30s

    # Logging
    log_queries: false  # Disabled in production for performance
    log_slow_queries: true
    slow_query_threshold: 2000  # ms

    # Performance
    shared_buffers: 8GB
    effective_cache_size: 24GB
    maintenance_work_mem: 2GB
    checkpoint_completion_target: 0.9
    wal_buffers: 16MB
    default_statistics_target: 100
    random_page_cost: 1.1  # For SSD
    effective_io_concurrency: 200

    # WAL and Replication
    wal_level: replica
    max_wal_senders: 10
    wal_keep_size: 1GB

  # Neo4j - Graph database for relationship mapping
  neo4j:
    uri: bolt://prod-neo4j.internal:7687
    user: neo4j
    password: ${NEO4J_PASSWORD}
    database: neo4j
    encrypted: true
    trust_strategy: TRUST_SYSTEM_CA_SIGNED_CERTIFICATES
    max_connection_pool_size: 50
    connection_acquisition_timeout: 60000
    max_transaction_retry_time: 30000

    # High Availability - Causal Cluster
    cluster:
      enabled: true
      routing_mode: READ_WRITE
      core_servers:
        - bolt://neo4j-core1.internal:7687
        - bolt://neo4j-core2.internal:7687
        - bolt://neo4j-core3.internal:7687
      read_replicas:
        - bolt://neo4j-read1.internal:7687
        - bolt://neo4j-read2.internal:7687

    # Memory Configuration
    heap:
      initial: 4G
      max: 8G
    page_cache: 10G

    # Logging
    logging:
      level: info
      log_queries: false

  # Redis - Caching and session store
  redis:
    host: prod-redis.internal
    port: 6379
    password: ${REDIS_PASSWORD}
    db: 0
    username: apollo

    # Connection options
    connection_timeout: 5000
    command_timeout: 5000
    max_retries: 5
    retry_delay: 100

    # TLS
    tls: true
    tls_ca: /etc/ssl/certs/ca.crt
    tls_cert: /etc/ssl/certs/redis-client.crt
    tls_key: /etc/ssl/private/redis-client.key

    # High Availability - Redis Sentinel
    sentinel: true
    sentinel_master: apollo-master
    sentinels:
      - host: sentinel1.internal
        port: 26379
      - host: sentinel2.internal
        port: 26379
      - host: sentinel3.internal
        port: 26379

    # Key prefixes
    key_prefixes:
      cache: "apollo:prod:cache:"
      session: "apollo:prod:session:"
      queue: "apollo:prod:queue:"
      pubsub: "apollo:prod:pubsub:"
      lock: "apollo:prod:lock:"

    # TTL settings
    default_ttl: 1800  # 30 minutes
    session_ttl: 900   # 15 minutes
    cache_ttl: 600     # 10 minutes

    # Memory Management
    maxmemory: 16gb
    maxmemory_policy: allkeys-lru

    # Persistence
    persistence:
      rdb: true
      aof: true
      aof_fsync: everysec

  # Elasticsearch - Full-text search and analytics
  elasticsearch:
    nodes:
      - https://elastic1.internal:9200
      - https://elastic2.internal:9200
      - https://elastic3.internal:9200

    username: apollo
    password: ${ELASTICSEARCH_PASSWORD}

    # SSL/TLS
    ssl: true
    ssl_ca: /etc/ssl/certs/ca.crt
    ssl_verify_certificates: true

    # Indices
    indices:
      cases: apollo_cases_prod
      evidence: apollo_evidence_prod
      intelligence: apollo_intel_prod
      surveillance: apollo_surveillance_prod
      audit: apollo_audit_prod

    # Index settings
    number_of_shards: 3
    number_of_replicas: 2
    refresh_interval: 5s

    # Index Lifecycle Management
    ilm:
      enabled: true
      hot_phase: 7d
      warm_phase: 30d
      cold_phase: 90d
      delete_phase: 365d

    # Request options
    request_timeout: 30000
    ping_timeout: 3000
    max_retries: 3
    compression: true

    # Performance
    max_concurrent_shard_requests: 5
    max_concurrent_searches: 20

  # MongoDB - Document store for unstructured data
  mongodb:
    connection_string: ${MONGODB_URL}
    database: apollo

    # Replica Set
    replica_set: apollo-rs
    read_preference: primaryPreferred
    write_concern: majority
    read_concern: majority

    # Connection options
    max_pool_size: 50
    min_pool_size: 10
    connect_timeout: 10000
    socket_timeout: 30000
    server_selection_timeout: 5000
    heartbeat_frequency: 10000

    # SSL/TLS
    ssl: true
    ssl_ca: /etc/ssl/certs/ca.crt
    ssl_cert: /etc/ssl/certs/mongo-client.pem
    ssl_validate: true

    # Collections
    collections:
      raw_intelligence: raw_intel
      social_media: social_media_data
      dark_web: dark_web_intel
      documents: documents
      media: media_files

    # Sharding (for scale)
    sharded: false  # Enable when needed
    shard_key: case_id

    # Compression
    compression: snappy

  # RabbitMQ - Message queue
  rabbitmq:
    nodes:
      - amqp://prod-rabbit1.internal:5672
      - amqp://prod-rabbit2.internal:5672
      - amqp://prod-rabbit3.internal:5672

    user: apollo
    password: ${RABBITMQ_PASSWORD}
    vhost: /apollo

    # Connection options
    heartbeat: 60
    connection_timeout: 10000
    channel_max: 100
    frame_max: 131072

    # SSL/TLS
    ssl: true
    ssl_options:
      ca: /etc/ssl/certs/ca.crt
      cert: /etc/ssl/certs/rabbitmq-client.crt
      key: /etc/ssl/private/rabbitmq-client.key
      verify: verify_peer
      fail_if_no_peer_cert: true

    # High Availability
    ha_mode: all
    ha_sync_mode: automatic

    # Exchanges
    exchanges:
      alerts:
        name: apollo.alerts
        type: topic
        durable: true
        auto_delete: false
      tasks:
        name: apollo.tasks
        type: direct
        durable: true
        auto_delete: false
      events:
        name: apollo.events
        type: fanout
        durable: true
        auto_delete: false

    # Queues
    queues:
      high_priority:
        name: apollo.tasks.high
        durable: true
        max_priority: 10
        max_length: 100000
        message_ttl: 86400000  # 24 hours
      normal_priority:
        name: apollo.tasks.normal
        durable: true
        max_length: 500000
        message_ttl: 604800000  # 7 days
      surveillance:
        name: apollo.surveillance
        durable: true
        max_length: 1000000
      intelligence:
        name: apollo.intelligence
        durable: true
        max_length: 500000

    # Dead Letter Exchange
    dlx:
      enabled: true
      exchange: apollo.dlx
      queue: apollo.dlq

  # TimescaleDB - Time-series data
  timescaledb:
    host: prod-timescale.internal
    port: 5432
    database: apollo_timeseries
    user: apollo_admin
    password: ${TIMESCALE_PASSWORD}
    pool_size: 30
    max_connections: 60

    # SSL/TLS
    ssl: true
    ssl_mode: require
    ssl_ca: /etc/ssl/certs/ca.crt

    # Hypertables
    hypertables:
      surveillance_events:
        table: surveillance_events
        time_column: timestamp
        chunk_time_interval: 6 hours
        retention_policy: 365 days
        compression_after: 7 days
        replication_factor: 2

      system_metrics:
        table: system_metrics
        time_column: timestamp
        chunk_time_interval: 1 hour
        retention_policy: 90 days
        compression_after: 1 day
        replication_factor: 2

      api_requests:
        table: api_requests
        time_column: timestamp
        chunk_time_interval: 1 day
        retention_policy: 180 days
        compression_after: 7 days
        replication_factor: 2

      audit_logs:
        table: audit_logs
        time_column: timestamp
        chunk_time_interval: 1 day
        retention_policy: 2555 days  # 7 years for compliance
        compression_after: 30 days
        replication_factor: 3

    # Compression
    compression:
      enabled: true
      algorithm: lz4
      orderby: timestamp DESC
      segmentby: case_id

    # Continuous aggregates
    continuous_aggregates:
      enabled: true
      surveillance_hourly:
        view_name: surveillance_events_hourly
        time_bucket: 1 hour
        refresh_lag: 1 hour
        retention: 730 days  # 2 years

      surveillance_daily:
        view_name: surveillance_events_daily
        time_bucket: 1 day
        refresh_lag: 1 day
        retention: 2555 days  # 7 years

# Database migration settings
migrations:
  auto_migrate: false  # Manual migrations in production
  create_schema: false
  sync_models: false
  require_approval: true

# Backup configuration
backup:
  enabled: true
  frequency: daily
  time: 02:00  # 2 AM UTC
  retention: 90 days

  # Full backups
  full_backup:
    frequency: weekly
    day: sunday
    retention: 365 days

  # Incremental backups
  incremental_backup:
    frequency: hourly
    retention: 7 days

  # Point-in-Time Recovery
  pitr:
    enabled: true
    wal_archival: true
    archive_retention: 30 days

  # Backup storage
  storage:
    type: s3
    bucket: apollo-backups-production
    region: us-east-1
    encryption: aes-256
    compression: true

  # Backup validation
  validation:
    enabled: true
    test_restore: weekly

# Monitoring
monitoring:
  enabled: true
  check_interval: 10s
  alert_on_failure: true

  # Health check queries
  health_checks:
    postgresql: "SELECT 1"
    neo4j: "RETURN 1"
    redis: "PING"
    elasticsearch: "GET /_cluster/health"
    mongodb: "db.adminCommand('ping')"
    rabbitmq: "check_aliveness"
    timescaledb: "SELECT 1"

  # Performance metrics
  metrics:
    - connection_pool_usage
    - query_performance
    - replication_lag
    - cache_hit_ratio
    - disk_usage
    - memory_usage
    - transaction_rate
    - error_rate

  # Alerts
  alerts:
    replication_lag_threshold: 10s
    connection_pool_threshold: 80%
    disk_usage_threshold: 85%
    slow_query_threshold: 5000  # ms
    error_rate_threshold: 1%

# Connection retry settings
retry:
  max_attempts: 10
  initial_delay: 1000  # ms
  max_delay: 30000     # ms
  backoff_multiplier: 2
  jitter: true

# Disaster Recovery
disaster_recovery:
  enabled: true

  # Geographic replication
  geo_replication:
    enabled: true
    primary_region: us-east-1
    dr_region: us-west-2
    replication_lag_max: 60s

  # Automated failover
  failover:
    enabled: false  # Manual failover for safety
    health_check_failures: 5
    failover_timeout: 60s

  # Backup to DR site
  dr_backup:
    enabled: true
    replication: async
    lag_tolerance: 300s

# Security
security:
  # Encryption at rest
  encryption_at_rest: true
  encryption_algorithm: aes-256-gcm

  # Encryption in transit
  encryption_in_transit: true
  tls_version: 1.3

  # Key rotation
  key_rotation:
    enabled: true
    frequency: quarterly
    automatic: false  # Manual rotation for safety

  # Audit logging
  audit_logging:
    enabled: true
    log_connections: true
    log_disconnections: true
    log_queries: false  # Performance impact
    log_ddl: true
    log_admin_operations: true

# Maintenance windows
maintenance:
  # Automatic maintenance
  auto_vacuum: true
  auto_analyze: true

  # Maintenance window
  window:
    day: sunday
    start_time: "03:00"
    end_time: "05:00"
    timezone: UTC

  # Operations
  operations:
    - vacuum
    - analyze
    - reindex
    - update_statistics

# Compliance
compliance:
  cjis: true
  gdpr: true
  ccpa: true
  soc2: true
  iso27001: true
  hipaa: false  # Not handling health data

  # Data retention
  data_retention:
    audit_logs: 2555 days  # 7 years
    case_data: permanent
    surveillance_data: 365 days
    system_logs: 90 days

  # Data encryption
  encryption_required: true
  encryption_at_rest: true
  encryption_in_transit: true

version: '3.8'

# Apollo Platform - Production Docker Compose
# ===========================================================
# ⚠️  WARNING: This is a reference configuration
# ⚠️  For true production, use Kubernetes (see kubernetes/ directory)
# ===========================================================

services:
  # PostgreSQL - Primary database with replication
  postgres-primary:
    image: postgres:15-alpine
    container_name: apollo-postgres-primary
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: apollo
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data
      - ./ssl/postgres:/ssl:ro
    command: >
      -c ssl=on
      -c ssl_cert_file=/ssl/server.crt
      -c ssl_key_file=/ssl/server.key
      -c ssl_ca_file=/ssl/ca.crt
      -c max_connections=200
      -c shared_buffers=4GB
      -c effective_cache_size=12GB
      -c maintenance_work_mem=1GB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=16MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c wal_level=replica
      -c max_wal_senders=10
    networks:
      - apollo-prod
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d apollo"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

  # PostgreSQL Standby (for HA)
  postgres-standby:
    image: postgres:15-alpine
    container_name: apollo-postgres-standby
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - postgres_standby_data:/var/lib/postgresql/data
      - ./ssl/postgres:/ssl:ro
    depends_on:
      - postgres-primary
    networks:
      - apollo-prod
    restart: always

  # Redis Sentinel Configuration
  redis-master:
    image: redis:7-alpine
    container_name: apollo-redis-master
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 8gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
      --appendfsync everysec
    ports:
      - "6379:6379"
    volumes:
      - redis_master_data:/data
    networks:
      - apollo-prod
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  redis-sentinel-1:
    image: redis:7-alpine
    container_name: apollo-redis-sentinel-1
    command: >
      redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./redis/sentinel.conf:/etc/redis/sentinel.conf
      - redis_sentinel_1_data:/data
    ports:
      - "26379:26379"
    networks:
      - apollo-prod
    depends_on:
      - redis-master
    restart: always

  # RabbitMQ Cluster
  rabbitmq-node1:
    image: rabbitmq:3.12-management-alpine
    container_name: apollo-rabbitmq-node1
    hostname: rabbitmq-node1
    environment:
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE}
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_node1_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    networks:
      - apollo-prod
    restart: always

  rabbitmq-node2:
    image: rabbitmq:3.12-management-alpine
    container_name: apollo-rabbitmq-node2
    hostname: rabbitmq-node2
    environment:
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE}
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_node2_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    networks:
      - apollo-prod
    depends_on:
      - rabbitmq-node1
    restart: always

  # Elasticsearch Cluster
  elasticsearch-node1:
    image: elasticsearch:8.11.0
    container_name: apollo-elasticsearch-node1
    environment:
      - node.name=es-node1
      - cluster.name=apollo-cluster
      - discovery.seed_hosts=elasticsearch-node2,elasticsearch-node3
      - cluster.initial_master_nodes=es-node1,es-node2,es-node3
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    volumes:
      - elastic_node1_data:/usr/share/elasticsearch/data
      - ./ssl/elasticsearch:/usr/share/elasticsearch/config/certificates:ro
    networks:
      - apollo-prod
    restart: always

  # MongoDB Replica Set
  mongodb-primary:
    image: mongo:7
    container_name: apollo-mongodb-primary
    command: mongod --replSet apollo-rs --bind_ip_all --auth
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
    ports:
      - "27017:27017"
    volumes:
      - mongo_primary_data:/data/db
      - ./mongodb/keyfile:/data/keyfile:ro
    networks:
      - apollo-prod
    restart: always

  # TimescaleDB
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: apollo-timescale-prod
    environment:
      POSTGRES_USER: ${TIMESCALE_USER}
      POSTGRES_PASSWORD: ${TIMESCALE_PASSWORD}
      POSTGRES_DB: apollo_timeseries
    ports:
      - "5434:5432"
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./ssl/timescale:/ssl:ro
    command: >
      -c ssl=on
      -c ssl_cert_file=/ssl/server.crt
      -c ssl_key_file=/ssl/server.key
      -c max_connections=100
      -c shared_buffers=2GB
    networks:
      - apollo-prod
    restart: always

  # Nginx - Reverse proxy and load balancer
  nginx:
    image: nginx:alpine
    container_name: apollo-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./ssl/nginx:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - apollo-prod
    depends_on:
      - api-gateway
    restart: always

  # API Gateway
  api-gateway:
    image: apollo/api-gateway:latest
    container_name: apollo-api-gateway
    environment:
      NODE_ENV: production
      PORT: 4000
    env_file:
      - .env.production
    ports:
      - "4000:4000"
    networks:
      - apollo-prod
    depends_on:
      - postgres-primary
      - redis-master
      - rabbitmq-node1
    restart: always
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # Prometheus - Metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: apollo-prometheus-prod
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.prod.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - apollo-prod
    restart: always

  # Grafana - Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: apollo-grafana-prod
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SECURITY_ADMIN_USER: admin
      GF_SERVER_ROOT_URL: https://grafana.yourdomain.com
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_SECURITY_STRICT_TRANSPORT_SECURITY: "true"
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - apollo-prod
    depends_on:
      - prometheus
    restart: always

networks:
  apollo-prod:
    driver: bridge
    name: apollo-prod-network
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_primary_data:
  postgres_standby_data:
  redis_master_data:
  redis_sentinel_1_data:
  rabbitmq_node1_data:
  rabbitmq_node2_data:
  elastic_node1_data:
  mongo_primary_data:
  timescale_data:
  nginx_logs:
  prometheus_data:
  grafana_data:

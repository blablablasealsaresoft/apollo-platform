version: '3.8'

# Apollo Platform - Development Environment
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
# This file extends docker-compose.yml for development with hot-reload and debugging

services:
  # Hot-reload enabled BugTrace AI service
  bugtrace-ai-dev:
    build:
      context: ./ai-engine/bugtrace-ai
      dockerfile: Dockerfile.dev
    container_name: apollo-bugtrace-ai-dev
    environment:
      - NODE_ENV=development
      - DEBUG=apollo:bugtrace:*
      - LOG_LEVEL=debug
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - ./ai-engine/bugtrace-ai/src:/app/src:cached
      - ./ai-engine/bugtrace-ai/config:/app/config:cached
      - /app/node_modules
    ports:
      - "3005:3000"
      - "9229:9229"  # Node debugger
    networks:
      - apollo-network
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped
    command: npm run dev

  # Web Console with Vite hot-reload
  web-console-dev:
    build:
      context: ./frontend/web-console
      dockerfile: Dockerfile.dev
    container_name: apollo-web-console-dev
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000/api
      - VITE_WS_URL=ws://localhost:3000/ws
    volumes:
      - ./frontend/web-console/src:/app/src:cached
      - ./frontend/web-console/public:/app/public:cached
      - /app/node_modules
    ports:
      - "5173:5173"
    networks:
      - apollo-network
    restart: unless-stopped

  # Development PostgreSQL with trust authentication for easier access
  postgresql-dev:
    image: postgres:15-alpine
    container_name: apollo-postgresql-dev
    environment:
      POSTGRES_DB: apollo_dev
      POSTGRES_USER: apollo_dev
      POSTGRES_PASSWORD: apollo_dev_password
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - postgresql_dev_data:/var/lib/postgresql/data
      - ./infrastructure/databases/postgresql/schemas:/docker-entrypoint-initdb.d:ro
    ports:
      - "5435:5432"
    networks:
      - apollo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apollo_dev -d apollo_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Testing Database (Ephemeral - uses tmpfs for speed)
  postgresql-test:
    image: postgres:15-alpine
    container_name: apollo-postgresql-test
    environment:
      POSTGRES_DB: apollo_test
      POSTGRES_USER: apollo_test
      POSTGRES_PASSWORD: apollo_test_password
    tmpfs:
      - /var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - apollo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U apollo_test -d apollo_test"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Mailhog - Email Testing (catches all outgoing emails)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: apollo-mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - apollo-network
    restart: unless-stopped

  # Redis Commander - Redis GUI for development
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: apollo-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"
    networks:
      - apollo-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Elasticsearch Head - ES GUI for development
  elasticsearch-head:
    image: mobz/elasticsearch-head:5
    container_name: apollo-es-head
    ports:
      - "9100:9100"
    networks:
      - apollo-network
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped

  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: apollo-jaeger
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"  # Web UI
      - "14268:14268"
      - "14250:14250"
      - "9411:9411"
    networks:
      - apollo-network
    restart: unless-stopped

volumes:
  postgresql_dev_data:
    driver: local

networks:
  apollo-network:
    external: true
    name: apollo_apollo-network

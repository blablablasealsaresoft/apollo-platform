#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ” Running pre-commit checks..."

# Run lint-staged
npx lint-staged

# Run type checking
echo "ðŸ“ Type checking..."
npm run type-check || {
  echo "âŒ Type check failed. Please fix TypeScript errors."
  exit 1
}

# Run unit tests for changed files
echo "ðŸ§ª Running tests..."
npm run test:unit -- --bail --findRelatedTests || {
  echo "âŒ Tests failed. Please fix failing tests."
  exit 1
}

# Check for secrets
echo "ðŸ” Scanning for secrets..."
if command -v trufflehog &> /dev/null; then
  trufflehog filesystem . --since-commit HEAD --only-verified --fail || {
    echo "âŒ Secrets detected! Please remove them before committing."
    exit 1
  }
fi

# Check for large files
echo "ðŸ“¦ Checking file sizes..."
large_files=$(git diff --cached --name-only | xargs ls -l 2>/dev/null | awk '$5 > 5242880 {print $9}')
if [ ! -z "$large_files" ]; then
  echo "âŒ Large files detected (>5MB). Please use Git LFS or reduce file size:"
  echo "$large_files"
  exit 1
fi

echo "âœ… Pre-commit checks passed!"
